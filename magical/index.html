<html>
<head>
<script src="https://unpkg.com/obniz@3.30.0/obniz.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  .magic-container { background: white; padding: 20px; border-radius: 15px; margin: 10px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .magic-title { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; padding: 20px; border-radius: 15px; text-align: center; }
  .navigation-active { background: linear-gradient(45deg, #4CAF50, #45a049); color: white; }
  button { margin: 5px; padding: 12px 20px; font-size: 14px; border: none; border-radius: 8px; cursor: pointer; }
  .btn-magic { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; font-weight: bold; }
  input { padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; width: 300px; }
</style>
</head>
<body>

<div class="magic-title">
  <h1>ğŸª„ å®Œå…¨ç‰ˆé­”æ³•ã®æŒ‡è¼ªãƒŠãƒ“</h1>
  <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é“æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ </p>
</div>

<div class="magic-container" id="nav-container">
  <h3>ğŸ¯ é­”æ³•ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</h3>
  <input type="text" id="destination" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šç†Šè°·é§…ã€æ±äº¬é§…ï¼‰" value="">
  <button class="btn-magic" onclick="startWalkingNavigation()">ğŸš¶â€â™‚ï¸ æ­©è¡ŒãƒŠãƒ“é–‹å§‹</button>
  <button onclick="stopNavigation()" style="background: #f44336; color: white;">â¹ï¸ ãƒŠãƒ“åœæ­¢</button>
</div>

<div class="magic-container">
  <h4>ğŸ“ ç¾åœ¨ã®çŠ¶æ³</h4>
  <div id="location-display" style="background: #f0f8ff; padding: 15px; border-radius: 8px;">GPSå–å¾—ä¸­...</div>
  <div id="navigation-progress" style="margin-top: 10px; font-weight: bold;"></div>
</div>

<div class="magic-container">
  <h4>ğŸª„ é­”æ³•ã®æŒ‡è¼ªæŒ‡ç¤º</h4>
  <div id="ring-status" style="font-size: 20px; font-weight: bold; color: #4CAF50; text-align: center; padding: 15px; background: #f0f8ff; border-radius: 10px;">âœ¨ é­”æ³•å¾…æ©Ÿä¸­</div>
  <div id="current-instruction" style="font-size: 18px; margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; text-align: center;">ğŸ”® æŒ‡ç¤ºå¾…æ©Ÿä¸­</div>
  <div id="distance-info" style="text-align: center; color: #666; font-size: 16px;">è·é›¢æƒ…å ±å–å¾—ä¸­...</div>
</div>

<div id="map" style="height: 400px; width: 100%; border-radius: 10px; margin: 20px 0; border: 3px solid #4CAF50;"></div>

<div class="magic-container">
  <h4>ğŸ“Š ãƒŠãƒ“ãƒ­ã‚°</h4>
  <div id="magic-log" style="background: #f8f9fa; padding: 15px; font-family: monospace; height: 200px; overflow-y: scroll; border: 1px solid #ddd; border-radius: 8px;">
é­”æ³•ã®æŒ‡è¼ªã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...<br>
  </div>
</div>

<script>
var obniz = new Obniz("1481-6445");
var magicRing;
var map, directionsService, directionsRenderer, userMarker;
var currentPosition = null;
var route = null;
var currentStepIndex = 0;
var isNavigating = false;
var locationWatcher = null;

// é­”æ³•ã®è‰²ï¼ˆå®Œæˆç‰ˆï¼‰
const MAGIC_COLORS = {
  RIGHT: [0, 255, 100],      // å³æŠ˜ï¼šã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰
  LEFT: [30, 144, 255],      // å·¦æŠ˜ï¼šã‚µãƒ•ã‚¡ã‚¤ã‚¢
  STRAIGHT: [255, 215, 0],   // ç›´é€²ï¼šã‚´ãƒ¼ãƒ«ãƒ‰
  CALCULATING: [148, 0, 211], // è¨ˆç®—ä¸­ï¼šç¥ç§˜ç´«
  SUCCESS: [50, 205, 50],    // æˆåŠŸï¼šç·‘
  ARRIVED: [255, 105, 180],  // åˆ°ç€ï¼šç¥ç¦ãƒ”ãƒ³ã‚¯
  WARNING: [255, 140, 0],    // è­¦å‘Šï¼šã‚ªãƒ¬ãƒ³ã‚¸
  OFF: [0, 0, 0]
};

function log(message) {
  const now = new Date();
  const time = now.getHours() + ':' + 
               String(now.getMinutes()).padStart(2, '0') + ':' + 
               String(now.getSeconds()).padStart(2, '0');
  const logDiv = document.getElementById("magic-log");
  logDiv.innerHTML += '[' + time + '] ' + message + '<br>';
  logDiv.scrollTop = logDiv.scrollHeight;
}

obniz.onconnect = function() {
  log("âœ… obnizæ¥ç¶šæˆåŠŸ");
  log("ğŸª„ æœ€çµ‚ç‰ˆé­”æ³•ã®æŒ‡è¼ªã‚’åˆæœŸåŒ–ä¸­...");
  
  // å®Œæˆã—ãŸé­”æ³•ã®æŒ‡è¼ª
  magicRing = obniz.wired('WS2811', {
    gnd: 0,
    vcc: 1,
    din: 2
  });
  
  log("âœ¨ é­”æ³•ã®æŒ‡è¼ªæœ€çµ‚ç‰ˆãŒèµ·å‹•ï¼");
  
  // åˆæœŸåŒ–æ¼”å‡º
  initializationCelebration();
  
  obniz.display.clear();
  obniz.display.print('Final Magic!');
  
  // Google MapsåˆæœŸåŒ–
  initializeGoogleMaps();
  
  // GPSå–å¾—
  setTimeout(function() {
    getCurrentLocation();
  }, 2000);
};

async function initializationCelebration() {
  log("ğŸŠ æœ€çµ‚ç‰ˆèµ·å‹•è¨˜å¿µæ¼”å‡º");
  
  const finalColors = [
    [255, 0, 0], [255, 127, 0], [255, 255, 0], [0, 255, 0],
    [0, 255, 255], [0, 0, 255], [148, 0, 211], [255, 20, 147]
  ];
  
  for (let i = 0; i < 2; i++) {
    for (let color of finalColors) {
      magicRing.rgb(color[0], color[1], color[2]);
      await obniz.wait(150);
    }
  }
  
  magicRing.rgb(MAGIC_COLORS.SUCCESS[0], MAGIC_COLORS.SUCCESS[1], MAGIC_COLORS.SUCCESS[2]);
  await obniz.wait(2000);
  magicRing.rgb(0, 0, 0);
  
  log("âœ¨ èµ·å‹•æ¼”å‡ºå®Œäº†");
}

function initializeGoogleMaps() {
  log("ğŸ—ºï¸ Google Mapsæœ€çµ‚ç‰ˆåˆæœŸåŒ–");
  
  var center = { lat: 36.1402, lng: 139.4111 }; // ç†Šè°·å‘¨è¾º
  
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 17,
    center: center,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });
  
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers: false,
    polylineOptions: {
      strokeColor: "#FF6B6B",
      strokeWeight: 8
    }
  });
  directionsRenderer.setMap(map);
  
  log("âœ… Google Mapsæœ€çµ‚ç‰ˆåˆæœŸåŒ–å®Œäº†");
}

function getCurrentLocation() {
  log("ğŸ“ ç¾åœ¨åœ°å–å¾—é–‹å§‹");
  document.getElementById("location-display").innerHTML = "ğŸ”® GPSé­”æ³•ã§ç¾åœ¨åœ°å–å¾—ä¸­...";
  
  if (magicRing) {
    magicRing.rgb(MAGIC_COLORS.CALCULATING[0], MAGIC_COLORS.CALCULATING[1], MAGIC_COLORS.CALCULATING[2]);
  }
  
  navigator.geolocation.getCurrentPosition(
    function(position) {
      currentPosition = {
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        accuracy: position.coords.accuracy
      };
      
      var locationText = "ğŸ“ ç¾åœ¨åœ°å–å¾—æˆåŠŸï¼<br>";
      locationText += "ç·¯åº¦: " + currentPosition.lat.toFixed(6) + "<br>";
      locationText += "çµŒåº¦: " + currentPosition.lng.toFixed(6) + "<br>";
      locationText += "GPSç²¾åº¦: " + Math.round(currentPosition.accuracy) + "m";
      
      document.getElementById("location-display").innerHTML = locationText;
      
      log("âœ… GPSå–å¾—æˆåŠŸ: ç²¾åº¦" + Math.round(currentPosition.accuracy) + "m");
      
      // åœ°å›³æ›´æ–°
      if (map) {
        map.setCenter(currentPosition);
        updateUserMarker();
      }
      
      // æˆåŠŸã®é­”æ³•
      if (magicRing) {
        magicRing.rgb(MAGIC_COLORS.SUCCESS[0], MAGIC_COLORS.SUCCESS[1], MAGIC_COLORS.SUCCESS[2]);
        setTimeout(function() {
          magicRing.rgb(0, 0, 0);
        }, 2000);
      }
      
    },
    function(error) {
      log("âŒ GPSå–å¾—ã‚¨ãƒ©ãƒ¼: " + error.message);
      document.getElementById("location-display").innerHTML = "âŒ GPSå–å¾—å¤±æ•—: " + error.message;
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

function updateUserMarker() {
  if (!map || !currentPosition) return;
  
  if (userMarker) {
    userMarker.setPosition(currentPosition);
  } else {
    userMarker = new google.maps.Marker({
      position: currentPosition,
      map: map,
      title: "ç¾åœ¨åœ°",
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: 'blue',
        fillOpacity: 1,
        strokeColor: 'white',
        strokeWeight: 3,
        scale: 10
      }
    });
  }
}

async function startWalkingNavigation() {
  var destination = document.getElementById("destination").value.trim();
  
  if (!destination) {
    alert("ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  
  if (!currentPosition) {
    alert("ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ãã ã•ã„");
    getCurrentLocation();
    return;
  }
  
  log("ğŸš¶â€â™‚ï¸ " + destination + "ã¸ã®æ­©è¡ŒãƒŠãƒ“é–‹å§‹");
  document.getElementById("nav-container").className = "magic-container navigation-active";
  
  // è¨ˆç®—ä¸­ã®é­”æ³•
  magicRing.rgb(MAGIC_COLORS.CALCULATING[0], MAGIC_COLORS.CALCULATING[1], MAGIC_COLORS.CALCULATING[2]);
  document.getElementById("ring-status").innerHTML = "ğŸ”® ãƒ«ãƒ¼ãƒˆé­”æ³•è¨ˆç®—ä¸­...";
  
  var request = {
    origin: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
    destination: destination,
    travelMode: google.maps.TravelMode.WALKING,
    unitSystem: google.maps.UnitSystem.METRIC,
    language: 'ja'
  };
  
  directionsService.route(request, function(result, status) {
    if (status === google.maps.DirectionsStatus.OK) {
      directionsRenderer.setDirections(result);
      route = result.routes[0];
      currentStepIndex = 0;
      isNavigating = true;
      
      log("âœ… ãƒ«ãƒ¼ãƒˆè¨ˆç®—å®Œäº†: " + route.legs[0].distance.text + ", " + route.legs[0].duration.text);
      
      // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
      processCurrentStep();
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½ç½®è¿½è·¡é–‹å§‹
      startLocationTracking();
      
      log("ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ­©è¡Œè¿½è·¡é–‹å§‹");
      
    } else {
      log("âŒ ãƒ«ãƒ¼ãƒˆè¨ˆç®—å¤±æ•—: " + status);
      alert("ãƒ«ãƒ¼ãƒˆè¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + status);
    }
  });
}

function processCurrentStep() {
  if (!route || !isNavigating) return;
  
  var steps = route.legs[0].steps;
  
  if (currentStepIndex >= steps.length) {
    arrivalCelebration();
    return;
  }
  
  var step = steps[currentStepIndex];
  var instruction = step.instructions.replace(/<[^>]*>/g, '');
  var maneuver = step.maneuver || 'straight';
  
  document.getElementById("current-instruction").innerHTML = 
    "ğŸš¶ Step " + (currentStepIndex + 1) + "/" + steps.length + "<br>" +
    "ğŸ“ " + instruction + "<br>" +
    "ğŸ“ " + step.distance.text;
  
  document.getElementById("navigation-progress").innerHTML = 
    "é€²æ—: " + (currentStepIndex + 1) + "/" + steps.length + " ã‚¹ãƒ†ãƒƒãƒ—";
  
  log("ğŸ“ Step " + (currentStepIndex + 1) + ": " + instruction);
  
  showMagicDirection(maneuver, instruction);
}

function showMagicDirection(maneuver, instruction) {
  var color, statusText, displayText;
  
  if (maneuver.includes('right') || instruction.includes('å³')) {
    color = MAGIC_COLORS.RIGHT;
    statusText = "â¡ï¸ å³æŠ˜ã®é­”æ³•ç™ºå‹•";
    displayText = "Turn Right";
  } else if (maneuver.includes('left') || instruction.includes('å·¦')) {
    color = MAGIC_COLORS.LEFT;
    statusText = "â¬…ï¸ å·¦æŠ˜ã®é­”æ³•ç™ºå‹•";
    displayText = "Turn Left";
  } else {
    color = MAGIC_COLORS.STRAIGHT;
    statusText = "â¬†ï¸ ç›´é€²ã®é­”æ³•ç™ºå‹•";
    displayText = "Go Straight";
  }
  
  document.getElementById("ring-status").innerHTML = statusText;
  magicRing.rgb(color[0], color[1], color[2]);
  
  obniz.display.clear();
  obniz.display.print(displayText);
  
  log("ğŸª„ " + statusText);
}

function startLocationTracking() {
  log("ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½ç½®è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹");
  
  if (locationWatcher) {
    navigator.geolocation.clearWatch(locationWatcher);
  }
  
  locationWatcher = navigator.geolocation.watchPosition(
    function(position) {
      currentPosition = {
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        accuracy: position.coords.accuracy
      };
      
      // ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
      if (userMarker) {
        userMarker.setPosition(currentPosition);
      }
      
      // åœ°å›³ä¸­å¿ƒæ›´æ–°
      if (isNavigating) {
        map.panTo(currentPosition);
      }
      
      // é€²è¡ŒçŠ¶æ³ãƒã‚§ãƒƒã‚¯
      if (isNavigating) {
        checkNavigationProgress();
      }
    },
    function(error) {
      log("âš ï¸ ä½ç½®è¿½è·¡ã‚¨ãƒ©ãƒ¼: " + error.message);
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 5000
    }
  );
}

function checkNavigationProgress() {
  if (!route || currentStepIndex >= route.legs[0].steps.length) return;
  
  var currentStep = route.legs[0].steps[currentStepIndex];
  var stepEndLocation = currentStep.end_location;
  
  var distance = calculateDistance(
    currentPosition.lat, currentPosition.lng,
    stepEndLocation.lat(), stepEndLocation.lng()
  );
  
  var distanceM = distance * 1000;
  
  document.getElementById("distance-info").innerHTML = 
    "ğŸ¯ æ¬¡ã®ãƒã‚¤ãƒ³ãƒˆã¾ã§: " + Math.round(distanceM) + "m";
  
  // 25mä»¥å†…ã§æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
  if (distanceM < 25) {
    log("âœ… Step " + (currentStepIndex + 1) + "å®Œäº† (æ®‹ã‚Š" + Math.round(distanceM) + "m)");
    currentStepIndex++;
    processCurrentStep();
  }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
  var R = 6371;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLon = (lon2 - lon1) * Math.PI / 180;
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.bit / 180) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

async function arrivalCelebration() {
  isNavigating = false;
  if (locationWatcher) {
    navigator.geolocation.clearWatch(locationWatcher);
  }
  
  log("ğŸ‰ ç›®çš„åœ°åˆ°ç€ï¼æœ€çµ‚ç¥ç¦é­”æ³•ç™ºå‹•ï¼");
  document.getElementById("ring-status").innerHTML = "ğŸŠ åˆ°ç€ï¼ç¥ç¦é­”æ³•ç™ºå‹•ä¸­";
  document.getElementById("current-instruction").innerHTML = "ğŸ‰ ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸï¼<br>âœ¨ é­”æ³•ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†";
  document.getElementById("nav-container").className = "magic-container";
  
  // æœ€çµ‚ç¥ç¦ã®è™¹è‰²é­”æ³•
  var celebrationColors = [
    [255, 0, 0], [255, 127, 0], [255, 255, 0], [0, 255, 0],
    [0, 255, 255], [0, 0, 255], [148, 0, 211], [255, 20, 147]
  ];
  
  for (var cycle = 0; cycle < 10; cycle++) {
    for (var color of celebrationColors) {
      magicRing.rgb(color[0], color[1], color[2]);
      await obniz.wait(120);
    }
  }
  
  magicRing.rgb(MAGIC_COLORS.ARRIVED[0], MAGIC_COLORS.ARRIVED[1], MAGIC_COLORS.ARRIVED[2]);
  
  obniz.display.clear();
  obniz.display.print('ARRIVED!!');
  
  log("ğŸª„âœ¨ é­”æ³•ã®æŒ‡è¼ªãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å®Œå…¨å®Œäº†ï¼ âœ¨ğŸª„");
}

function stopNavigation() {
  isNavigating = false;
  if (locationWatcher) {
    navigator.geolocation.clearWatch(locationWatcher);
  }
  
  magicRing.rgb(0, 0, 0);
  document.getElementById("ring-status").innerHTML = "â¹ï¸ ãƒŠãƒ“åœæ­¢";
  document.getElementById("current-instruction").innerHTML = "ğŸ”® æŒ‡ç¤ºå¾…æ©Ÿä¸­";
  document.getElementById("nav-container").className = "magic-container";
  log("â¹ï¸ é­”æ³•ãƒŠãƒ“åœæ­¢");
}
</script>

<!-- Google Maps API -->
<script async defer 
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGwQk-t30NN7TZ1J1tkRlLO2wamO4_7mk&callback=initializeGoogleMaps&language=ja">
</script>
</body>
</html>