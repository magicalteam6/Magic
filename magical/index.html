<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒã‚¸ã‚«ãƒ«ãƒŠãƒ“ãƒªãƒ³ã‚°</title>

  <!-- obniz -->
  <script src="https://unpkg.com/obniz@3.30.0/obniz.js"></script>

  <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet" />

  <!-- å¤–éƒ¨CSS -->
  <link rel="stylesheet" href="https://github.com/magicalteam6/Magic/edit/main/magical/magical-theme.css" />
</head>
<body>

  <!-- é­”æ³•ã®æ˜Ÿã®è£…é£¾ -->
  <div class="magic-decorations">
    <div class="magic-item" style="top:10%; left:15%;">âœ¨</div>
    <div class="magic-item" style="top:30%; left:70%;">ğŸŒŸ</div>
    <div class="magic-item" style="top:60%; left:40%;">ğŸ’«</div>
    <div class="magic-item" style="top:80%; left:80%;">â­</div>
  </div>

  <!-- é­”æ³•ã®ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
  <div class="magic-sparkles" id="sparkles"></div>

  <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
  <div class="magic-title">
    <h1>ğŸª„ ãƒã‚¸ã‚«ãƒ«ãƒŠãƒ“ãƒªãƒ³ã‚° ğŸ’</h1>
    <p>âœ¨ é“æ¡ˆå†…ã¯ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã«ãªã£ãŸ âœ¨</p>
    <div style="margin-top: 15px; font-size: 1.1em;">
      <span class="gem-accent">ğŸ’</span>
      <span class="gem-accent">ğŸŒŸ</span>
      <span class="gem-accent">âœ¨</span>
      <span class="gem-accent">ğŸ’–</span>
      <span class="gem-accent">ğŸŒˆ</span>
    </div>
  </div>

<div class="magic-container">
  <div class="section-title">
    <span class="gem-accent">ğŸ¯</span>
    é­”æ³•ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
    <span class="gem-accent">ğŸ¯</span>
  </div>
  
  <div style="text-align: center; margin: 20px 0;">
    <input type="text" id="destination" 
           placeholder="âœ¨ ç›®çš„åœ°ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šæ–°å®¿é§…ã€æ±äº¬é§…ï¼‰ğŸ’«" 
           value="">
  </div>
  
  <div class="button-container">
    <button class="btn-magic btn-voice" onclick="startVoiceInput()">
      ğŸ™ï¸ éŸ³å£°ã§ç›®çš„åœ°å…¥åŠ›
    </button>
    <button class="btn-magic btn-test" onclick="testColorDistinction()">
      ğŸ” è‰²åŒºåˆ¥ãƒ†ã‚¹ãƒˆ
    </button>
    <button class="btn-magic" onclick="startWalkingNavigation()">
      ğŸš¶â€â™€ï¸ æ­©è¡ŒãƒŠãƒ“é–‹å§‹
    </button>
    <button class="btn-stop" onclick="stopNavigation()">
      â¹ï¸ ãƒŠãƒ“åœæ­¢
    </button>
  </div>
</div>

<div class="magic-container">
  <div class="section-title">
    <span class="gem-accent">ğŸ“</span>
    ç¾åœ¨ã®çŠ¶æ³
    <span class="gem-accent">ğŸ“</span>
  </div>
  <div id="location-display" class="status-display">
    ğŸ”® GPSé­”æ³•ã§ç¾åœ¨åœ°å–å¾—ä¸­...
  </div>
  <div id="navigation-progress" class="status-display" 
       style="margin-top: 10px; font-weight: bold; text-align: center;">
  </div>
</div>

```html
<div class="magic-container ring-status-container">
  <div class="section-title">
    <span class="gem-accent">ğŸ’</span>
    ãƒã‚¸ã‚«ãƒ«ãƒªãƒ³ã‚°æŒ‡ç¤º
    <span class="gem-accent">ğŸ’</span>
  </div>
  <div id="ring-status" style="font-size: 24px; font-weight: bold; color: #c44569; text-align: center; padding: 20px;">
    âœ¨ é­”æ³•å¾…æ©Ÿä¸­ âœ¨
  </div>
  <div id="current-instruction" class="instruction-display">
    ğŸ”® æŒ‡ç¤ºå¾…æ©Ÿä¸­ ğŸ”®
  </div>
  <div id="distance-info" style="text-align: center; color: #c44569; font-size: 18px; font-weight: bold;">
    è·é›¢æƒ…å ±å–å¾—ä¸­...
  </div>
</div>

<div id="map"></div>

<div class="magic-container">
  <div class="section-title">
    <span class="gem-accent">ğŸ“Š</span>
    ãƒã‚¸ã‚«ãƒ«ãƒ­ã‚°
    <span class="gem-accent">ğŸ“Š</span>
  </div>
  <div id="magic-log" class="magic-log">
    âœ¨ é­”æ³•ã®æŒ‡è¼ªã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­... âœ¨<br>
  </div>
</div>

<script>
var obniz = new Obniz("1481-6445");
var magicRing;
var map, directionsService, directionsRenderer, userMarker;
var currentPosition = null;
var route = null;
var currentStepIndex = 0;
var isNavigating = false;
var locationWatcher = null;

// é­”æ³•ã®è‰²ï¼ˆæœ€çµ‚ç‰ˆï¼‰
const MAGIC_COLORS = {
  RIGHT: [255, 215, 0],      // å³æŠ˜ï¼šã‚·ãƒ£ã‚¤ãƒ‹ãƒ³ã‚°ã‚´ãƒ¼ãƒ«ãƒ‰
  LEFT: [148, 0, 211],       // å·¦æŠ˜ï¼šãƒã‚¸ã‚«ãƒ«ãƒ‘ãƒ¼ãƒ—ãƒ«
  STRAIGHT: [0, 255, 100],   // ç›´é€²ï¼šãƒŸãƒ©ã‚¯ãƒ«ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰
  CALCULATING: [30, 144, 255], // è¨ˆç®—ä¸­ï¼šãƒã‚¸ã‚«ãƒ«ã‚µãƒ•ã‚¡ã‚¤ã‚¢
  SUCCESS: [50, 205, 50],    // æˆåŠŸï¼šç·‘
  ARRIVED: [255, 105, 180],  // åˆ°ç€ï¼šãƒ—ãƒªãƒ³ã‚»ã‚¹ãƒ”ãƒ³ã‚¯
  WARNING: [255, 0, 0],      // è­¦å‘Šï¼šãƒ¬ãƒƒãƒ‰
  OFF: [0, 0, 0]
};

// ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”Ÿæˆ
function createSparkles() {
  const sparklesContainer = document.getElementById('sparkles');
  
  setInterval(() => {
    const sparkle = document.createElement('div');
    sparkle.className = 'sparkle';
    sparkle.style.left = Math.random() * 100 + '%';
    sparkle.style.animationDuration = (Math.random() * 3 + 2) + 's';
    sparkle.style.animationDelay = Math.random() * 2 + 's';
    
    sparklesContainer.appendChild(sparkle);
    
    setTimeout(() => {
      if (sparkle.parentNode) {
        sparkle.parentNode.removeChild(sparkle);
      }
    }, 5000);
  }, 500);
}

function log(message) {
  const now = new Date();
  const time = now.getHours() + ':' + 
               String(now.getMinutes()).padStart(2, '0') + ':' + 
               String(now.getSeconds()).padStart(2, '0');
  const logDiv = document.getElementById("magic-log");
  logDiv.innerHTML += '[' + time + '] ' + message + '<br>';
  logDiv.scrollTop = logDiv.scrollHeight;
}

obniz.onconnect = function() {
  log("âœ… obnizæ¥ç¶šæˆåŠŸ");
  log("ğŸª„ ãƒã‚¸ã‚«ãƒ«ãƒªãƒ³ã‚°ã‚’åˆæœŸåŒ–ä¸­...");
  
  // ãƒã‚¸ã‚«ãƒ«ãƒªãƒ³ã‚°åˆæœŸåŒ–
  magicRing = obniz.wired('WS2811', {
    gnd: 0,
    vcc: 1,
    din: 2
  });
  
  log("âœ¨ ãƒã‚¸ã‚«ãƒ«ãƒªãƒ³ã‚°ãŒèµ·å‹•ï¼");
  
  // åˆæœŸåŒ–æ¼”å‡º
  initializationCelebration();
  
  obniz.display.clear();
  obniz.display.print('Magical!');
  
  // Google MapsåˆæœŸåŒ–
  initializeGoogleMaps();
  
  // ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–‹å§‹
  createSparkles();
  
  // GPSå–å¾—
  setTimeout(function() {
    getCurrentLocation();
  }, 2000);
};

async function initializationCelebration() {
  log("ğŸŠ ãƒã‚¸ã‚«ãƒ«èµ·å‹•æ¼”å‡º");
  
  const magicalColors = [
    MAGIC_COLORS.RIGHT,      // ã‚·ãƒ£ã‚¤ãƒ‹ãƒ³ã‚°ã‚´ãƒ¼ãƒ«ãƒ‰
    MAGIC_COLORS.LEFT,       // ãƒã‚¸ã‚«ãƒ«ãƒ‘ãƒ¼ãƒ—ãƒ«
    MAGIC_COLORS.STRAIGHT,   // ãƒŸãƒ©ã‚¯ãƒ«ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰
    MAGIC_COLORS.CALCULATING,// ãƒã‚¸ã‚«ãƒ«ã‚µãƒ•ã‚¡ã‚¤ã‚¢
    MAGIC_COLORS.ARRIVED     // ãƒ—ãƒªãƒ³ã‚»ã‚¹ãƒ”ãƒ³ã‚¯
  ];
  
  for (let i = 0; i < 3; i++) {
    for (let color of magicalColors) {
      magicRing.rgb(color[0], color[1], color[2]);
      await obniz.wait(200);
    }
  }
  
  magicRing.rgb(MAGIC_COLORS.SUCCESS[0], MAGIC_COLORS.SUCCESS[1], MAGIC_COLORS.SUCCESS[2]);
  await obniz.wait(2000);
  magicRing.rgb(0, 0, 0);
  
  log("âœ¨ ãƒã‚¸ã‚«ãƒ«æ¼”å‡ºå®Œäº†");
}

function initializeGoogleMaps() {
  log("ğŸ—ºï¸ Google MapsåˆæœŸåŒ–");
  
  var center = { lat: 35.6813, lng: 139.7660 };
  
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 17,
    center: center,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    styles: [
      {
        "featureType": "all",
        "elementType": "geometry",
        "stylers": [{"saturation": 30}, {"lightness": 30}]
      }
    ]
  });
  
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers: false,
    polylineOptions: {
      strokeColor: "#ff6b9d",
      strokeWeight: 6,
      strokeOpacity: 0.8
    }
  });
  directionsRenderer.setMap(map);
  
  log("âœ… Google MapsåˆæœŸåŒ–å®Œäº†");
}

function getCurrentLocation() {
  log("ğŸ“ ç¾åœ¨åœ°å–å¾—é–‹å§‹");
  document.getElementById("location-display").innerHTML = "ğŸ”® GPSé­”æ³•ã§ç¾åœ¨åœ°å–å¾—ä¸­...";
  
  if (magicRing) {
    magicRing.rgb(MAGIC_COLORS.CALCULATING[0], MAGIC_COLORS.CALCULATING[1], MAGIC_COLORS.CALCULATING[2]);
  }
  
  navigator.geolocation.getCurrentPosition(
    function(position) {
      currentPosition = {
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        accuracy: position.coords.accuracy
      };
      
      var locationText = "ğŸ“ ç¾åœ¨åœ°å–å¾—æˆåŠŸï¼ âœ¨<br>";
      locationText += "ç·¯åº¦: " + currentPosition.lat.toFixed(6) + "<br>";
      locationText += "çµŒåº¦: " + currentPosition.lng.toFixed(6) + "<br>";
      locationText += "GPSç²¾åº¦: " + Math.round(currentPosition.accuracy) + "m ğŸ’";
      
      document.getElementById("location-display").innerHTML = locationText;
      
      log("âœ… GPSå–å¾—æˆåŠŸ: ç²¾åº¦" + Math.round(currentPosition.accuracy) + "m");
      
      // åœ°å›³æ›´æ–°
      if (map) {
        map.setCenter(currentPosition);
        updateUserMarker();
      }
      
      // æˆåŠŸã®é­”æ³•
      if (magicRing) {
        magicRing.rgb(MAGIC_COLORS.SUCCESS[0], MAGIC_COLORS.SUCCESS[1], MAGIC_COLORS.SUCCESS[2]);
        setTimeout(function() {
          magicRing.rgb(0, 0, 0);
        }, 2000);
      }
      
    },
    function(error) {
      log("âŒ GPSå–å¾—ã‚¨ãƒ©ãƒ¼: " + error.message);
      document.getElementById("location-display").innerHTML = "âŒ GPSå–å¾—å¤±æ•—: " + error.message;
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

function updateUserMarker() {
  if (!map || !currentPosition) return;
  
  if (userMarker) {
    userMarker.setPosition(currentPosition);
  } else {
    userMarker = new google.maps.Marker({
      position: currentPosition,
      map: map,
      title: "ç¾åœ¨åœ°",
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: '#ff6b9d',
        fillOpacity: 1,
        strokeColor: 'white',
        strokeWeight: 3,
        scale: 12
      }
    });
  }
}

async function startWalkingNavigation() {
  var destination = document.getElementById("destination").value.trim();
  
  if (!destination) {
    alert("âœ¨ ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ ğŸ’«");
    return;
  }
  
  if (!currentPosition) {
    alert("ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ãã ã•ã„");
    getCurrentLocation();
    return;
  }
  
  log("ğŸš¶â€â™€ï¸ " + destination + "ã¸ã®ãƒã‚¸ã‚«ãƒ«ãƒŠãƒ“é–‹å§‹");
  document.getElementById("nav-container") && (document.getElementById("nav-container").className = "magic-container navigation-active");
  
  // è¨ˆç®—ä¸­ã®é­”æ³•
  magicRing.rgb(MAGIC_COLORS.CALCULATING[0], MAGIC_COLORS.CALCULATING[1], MAGIC_COLORS.CALCULATING[2]);
  document.getElementById("ring-status").innerHTML = "ğŸ”® ãƒ«ãƒ¼ãƒˆé­”æ³•è¨ˆç®—ä¸­...";
  
  var request = {
    origin: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
    destination: destination,
    travelMode: google.maps.TravelMode.WALKING,
    unitSystem: google.maps.UnitSystem.METRIC,
    language: 'ja'
  };
  
  directionsService.route(request, function(result, status) {
    if (status === google.maps.DirectionsStatus.OK) {
      directionsRenderer.setDirections(result);
      route = result.routes[0];
      currentStepIndex = 0;
      isNavigating = true;
      
      log("âœ… ãƒ«ãƒ¼ãƒˆè¨ˆç®—å®Œäº†: " + route.legs[0].distance.text + ", " + route.legs[0].duration.text);
      
      // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
      processCurrentStep();
      
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½ç½®è¿½è·¡é–‹å§‹
      startLocationTracking();
      
      log("ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ­©è¡Œè¿½è·¡é–‹å§‹");
      
    } else {
      log("âŒ ãƒ«ãƒ¼ãƒˆè¨ˆç®—å¤±æ•—: " + status);
      alert("âœ¨ ãƒ«ãƒ¼ãƒˆè¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + status + " ğŸ’«");
    }
  });
}

function processCurrentStep() {
  if (!route || !isNavigating) return;
  
  var steps = route.legs[0].steps;
  
  if (currentStepIndex >= steps.length) {
    arrivalCelebration();
    return;
  }
  
  var step = steps[currentStepIndex];
  var instruction = step.instructions.replace(/<[^>]*>/g, '');
  var maneuver = step.maneuver || 'straight';
  
  document.getElementById("current-instruction").innerHTML = 
    "ğŸš¶â€â™€ï¸ Step " + (currentStepIndex + 1) + "/" + steps.length + "<br>" +
    "ğŸ’« " + instruction + "<br>" +
    "ğŸ“ " + step.distance.text + " âœ¨";
  
  document.getElementById("navigation-progress").innerHTML = 
    "âœ¨ é€²æ—: " + (currentStepIndex + 1) + "/" + steps.length + " ã‚¹ãƒ†ãƒƒãƒ— ğŸ’";
  
  log("ğŸ“ Step " + (currentStepIndex + 1) + ": " + instruction);
  
  showMagicDirection(maneuver, instruction);
}

function showMagicDirection(maneuver, instruction) {
  var color, statusText, displayText;
  
  if (maneuver.includes('right') || instruction.includes('å³')) {
    color = MAGIC_COLORS.RIGHT;
    statusText = "âœ¨ ã‚·ãƒ£ã‚¤ãƒ‹ãƒ³ã‚°ã‚´ãƒ¼ãƒ«ãƒ‰ç™ºå‹• ğŸ’›";
    displayText = "Turn Right";
  } else if (maneuver.includes('left') || instruction.includes('å·¦')) {
    color = MAGIC_COLORS.LEFT;
    statusText = "ğŸ’œ ãƒã‚¸ã‚«ãƒ«ãƒ‘ãƒ¼ãƒ—ãƒ«ç™ºå‹• âœ¨";
    displayText = "Turn Left";
  } else {
    color = MAGIC_COLORS.STRAIGHT;
    statusText = "ğŸ’š ãƒŸãƒ©ã‚¯ãƒ«ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ç™ºå‹• âœ¨";
    displayText = "Go Straight";
  }
  
  document.getElementById("ring-status").innerHTML = statusText;
  magicRing.rgb(color[0], color[1], color[2]);
  
  obniz.display.clear();
  obniz.display.print(displayText);
  
  log("ğŸª„ " + statusText);
}

function startLocationTracking() {
  log("ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½ç½®è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹");
  
  if (locationWatcher) {
    navigator.geolocation.clearWatch(locationWatcher);
  }
  
  locationWatcher = navigator.geolocation.watchPosition(
    function(position) {
      currentPosition = {
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        accuracy: position.coords.accuracy
      };
      
      // ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
      if (userMarker) {
        userMarker.setPosition(currentPosition);
      }
      
      // åœ°å›³ä¸­å¿ƒæ›´æ–°
      if (isNavigating) {
        map.panTo(currentPosition);
      }
      
      // é€²è¡ŒçŠ¶æ³ãƒã‚§ãƒƒã‚¯
      if (isNavigating) {
        checkNavigationProgress();
      }
    },
    function(error) {
      log("âš ï¸ ä½ç½®è¿½è·¡ã‚¨ãƒ©ãƒ¼: " + error.message);
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 5000
    }
  );
}
function checkNavigationProgress() {
  if (!route || currentStepIndex >= route.legs[0].steps.length) return;
  
  var currentStep = route.legs[0].steps[currentStepIndex];
  var stepEndLocation = currentStep.end_location;
  
  var distance = calculateDistance(
    currentPosition.lat, currentPosition.lng,
    stepEndLocation.lat(), stepEndLocation.lng()
  );
  
  var distanceM = distance * 1000;
  
  document.getElementById("distance-info").innerHTML = 
    "ğŸ¯ æ¬¡ã®ãƒã‚¤ãƒ³ãƒˆã¾ã§: " + Math.round(distanceM) + "m âœ¨";
  
  // 25mä»¥å†…ã§æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
  if (distanceM < 25) {
    log("âœ… Step " + (currentStepIndex + 1) + "å®Œäº† (æ®‹ã‚Š" + Math.round(distanceM) + "m)");
    currentStepIndex++;
    processCurrentStep();
  }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
  var R = 6371;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLon = (lon2 - lon1) * Math.PI / 180;
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

async function arrivalCelebration() {
  isNavigating = false;
  if (locationWatcher) {
    navigator.geolocation.clearWatch(locationWatcher);
  }
  
  log("ğŸ‰ ç›®çš„åœ°åˆ°ç€ï¼ãƒ—ãƒªãƒ³ã‚»ã‚¹ãƒ”ãƒ³ã‚¯æœ€çµ‚é­”æ³•ç™ºå‹•ï¼");
  document.getElementById("ring-status").innerHTML = "ğŸŠ ãƒ—ãƒªãƒ³ã‚»ã‚¹ãƒ”ãƒ³ã‚¯å¤§ç™ºå‹•ä¸­ ğŸ’–";
  document.getElementById("current-instruction").innerHTML = 
    "ğŸ‰ ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸï¼<br>âœ¨ ãƒã‚¸ã‚«ãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† ğŸ’«";
  
  // æœ€çµ‚ç¥ç¦ã®é­”æ³•
  var celebrationColors = [
    MAGIC_COLORS.RIGHT,    // ã‚·ãƒ£ã‚¤ãƒ‹ãƒ³ã‚°ã‚´ãƒ¼ãƒ«ãƒ‰
    MAGIC_COLORS.LEFT,     // ãƒã‚¸ã‚«ãƒ«ãƒ‘ãƒ¼ãƒ—ãƒ«  
    MAGIC_COLORS.STRAIGHT, // ãƒŸãƒ©ã‚¯ãƒ«ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰
    MAGIC_COLORS.ARRIVED   // ãƒ—ãƒªãƒ³ã‚»ã‚¹ãƒ”ãƒ³ã‚¯
  ];
  
  for (var cycle = 0; cycle < 8; cycle++) {
    for (var color of celebrationColors) {
      magicRing.rgb(color[0], color[1], color[2]);
      await obniz.wait(150);
    }
  }
  
  // æœ€çµ‚çš„ã«ãƒ—ãƒªãƒ³ã‚»ã‚¹ãƒ”ãƒ³ã‚¯ã§å›ºå®š
  magicRing.rgb(MAGIC_COLORS.ARRIVED[0], MAGIC_COLORS.ARRIVED[1], MAGIC_COLORS.ARRIVED[2]);
  
  obniz.display.clear();
  obniz.display.print('PRINCESS!');
  
  log("ğŸª„âœ¨ ãƒ—ãƒªãƒ³ã‚»ã‚¹ãƒ”ãƒ³ã‚¯é­”æ³•å®Œäº†ï¼ ãƒã‚¸ã‚«ãƒ«ãƒŠãƒ“çµ‚äº† âœ¨ğŸª„");
}

function stopNavigation() {
  isNavigating = false;
  if (locationWatcher) {
    navigator.geolocation.clearWatch(locationWatcher);
  }
  
  magicRing.rgb(0, 0, 0);
  document.getElementById("ring-status").innerHTML = "â¹ï¸ ãƒŠãƒ“åœæ­¢ âœ¨";
  document.getElementById("current-instruction").innerHTML = "ğŸ”® æŒ‡ç¤ºå¾…æ©Ÿä¸­ ğŸ”®";
  document.getElementById("nav-container") && (document.getElementById("nav-container").className = "magic-container");
  log("â¹ï¸ ãƒã‚¸ã‚«ãƒ«ãƒŠãƒ“åœæ­¢");
}

function startVoiceInput() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("ğŸ’« ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã‚’ä½¿ã£ã¦ãã ã•ã„ âœ¨");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'ja-JP';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = function() {
    log("ğŸ™ï¸ éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚è©±ã—ã‹ã‘ã¦ãã ã•ã„ï¼");
    document.getElementById("ring-status").innerHTML = "ğŸ¤ éŸ³å£°å…¥åŠ›ä¸­... âœ¨";
    if (magicRing) {
      magicRing.rgb(MAGIC_COLORS.CALCULATING[0], MAGIC_COLORS.CALCULATING[1], MAGIC_COLORS.CALCULATING[2]);
    }
  };

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    document.getElementById("destination").value = transcript;
    log("ğŸ“ éŸ³å£°èªè­˜çµæœ: " + transcript + " âœ¨");
    document.getElementById("ring-status").innerHTML = "âœ… éŸ³å£°èªè­˜æˆåŠŸ ğŸ’«";

    if (magicRing) {
      magicRing.rgb(MAGIC_COLORS.SUCCESS[0], MAGIC_COLORS.SUCCESS[1], MAGIC_COLORS.SUCCESS[2]);
      setTimeout(() => {
        magicRing.rgb(0, 0, 0);
        document.getElementById("ring-status").innerHTML = "âœ¨ é­”æ³•å¾…æ©Ÿä¸­ âœ¨";
      }, 2000);
    }
  };

  recognition.onerror = function(event) {
    log("âš ï¸ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: " + event.error);
    document.getElementById("ring-status").innerHTML = "âŒ éŸ³å£°èªè­˜å¤±æ•— ğŸ’«";
    if (magicRing) {
      magicRing.rgb(MAGIC_COLORS.WARNING[0], MAGIC_COLORS.WARNING[1], MAGIC_COLORS.WARNING[2]);
      setTimeout(() => {
        magicRing.rgb(0, 0, 0);
        document.getElementById("ring-status").innerHTML = "âœ¨ é­”æ³•å¾…æ©Ÿä¸­ âœ¨";
      }, 2000);
    }
  };

  recognition.onend = function() {
    log("ğŸ¤ éŸ³å£°å…¥åŠ›ã‚’çµ‚äº†ã—ã¾ã—ãŸ âœ¨");
  };

  recognition.start();
}

// è‰²åŒºåˆ¥ãƒ†ã‚¹ãƒˆé–¢æ•°
  async function testColorDistinction() {
  if (!magicRing) {
    alert("ğŸ’ ãƒã‚¸ã‚«ãƒ«ãƒªãƒ³ã‚°ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ âœ¨");
    return;
  }

  log("ğŸ” ãƒã‚¸ã‚«ãƒ«ã‚«ãƒ©ãƒ¼åŒºåˆ¥ãƒ†ã‚¹ãƒˆé–‹å§‹ï¼");
  
  const testColors = [
    { name: "ã‚·ãƒ£ã‚¤ãƒ‹ãƒ³ã‚°ã‚´ãƒ¼ãƒ«ãƒ‰", color: MAGIC_COLORS.RIGHT, icon: "ğŸ’›", desc: "å³æŠ˜" },
    { name: "ãƒã‚¸ã‚«ãƒ«ãƒ‘ãƒ¼ãƒ—ãƒ«", color: MAGIC_COLORS.LEFT, icon: "ğŸ’œ", desc: "å·¦æŠ˜" },
    { name: "ãƒŸãƒ©ã‚¯ãƒ«ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰", color: MAGIC_COLORS.STRAIGHT, icon: "ğŸ’š", desc: "ç›´é€²" },
    { name: "ãƒã‚¸ã‚«ãƒ«ã‚µãƒ•ã‚¡ã‚¤ã‚¢", color: MAGIC_COLORS.CALCULATING, icon: "ğŸ’™", desc: "è¨ˆç®—ä¸­" },
    { name: "ãƒ—ãƒªãƒ³ã‚»ã‚¹ãƒ”ãƒ³ã‚¯", color: MAGIC_COLORS.ARRIVED, icon: "ğŸ’–", desc: "åˆ°ç€" }
  ];
  
  for (let testColor of testColors) {
    log(`\${testColor.icon} \${testColor.name}ï¼ˆ\${testColor.desc}ï¼‰ãƒ†ã‚¹ãƒˆä¸­...`);
    document.getElementById("ring-status").innerHTML = 
      `\${testColor.icon} \${testColor.name}ç™ºå‹•ä¸­ âœ¨`;
    magicRing.rgb(...testColor.color);
    await obniz.wait(3000);
    
    // é–“éš”
    magicRing.rgb(0, 0, 0);
    await obniz.wait(500);
  }
  
  document.getElementById("ring-status").innerHTML = "âœ¨ ã‚«ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆå®Œäº†ï¼ ğŸ’«";
  log("âœ¨ ãƒã‚¸ã‚«ãƒ«ã‚«ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆå®Œäº†ï¼");
}
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
window.addEventListener('load', function() {
  log("âœ¨ ãƒã‚¸ã‚«ãƒ«ãƒŠãƒ“ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†ï¼ ğŸ’");
});

// obnizã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
obniz.onerror = function(error) {
  log("âŒ obnizæ¥ç¶šã‚¨ãƒ©ãƒ¼: " + error.message);
  if (error.message.includes("connected from 1 clients")) {
    log("âš ï¸ ä»–ã®ã‚¿ãƒ–ã§obnizãŒä½¿ç”¨ä¸­ã§ã™ã€‚ä»–ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ãã ã•ã„");
  }
};

// ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹æ™‚ã®å‡¦ç†
window.addEventListener('beforeunload', function() {
  if (magicRing) {
    magicRing.rgb(0, 0, 0); // ãƒ©ã‚¤ãƒˆæ¶ˆç¯
  }
});

</script>

<!-- Google Maps API -->
<script async defer 
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGwQk-t30NN7TZ1J1tkRlLO2wamO4_7mk&callback=initializeGoogleMaps&language=ja">
</script>

</body>
</html>

